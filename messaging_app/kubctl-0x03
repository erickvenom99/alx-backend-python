#!/usr/bin/env bash

# File: messaging_app/kubctl-0x03

DEPLOYMENT_FILE="blue_deployment.yaml"
DEPLOYMENT_NAME="django-app-blue"
SERVICE_NAME="django-app-service"

# --- Function to check for kubectl and curl availability ---
check_prerequisites() {
    if ! command -v kubectl &> /dev/null; then
        echo "ðŸš¨ ERROR: kubectl is not installed or not in PATH." >&2
        exit 1
    fi
    if ! command -v curl &> /dev/null; then
        echo "ðŸš¨ ERROR: curl is not installed or not in PATH." >&2
        exit 1
    fi
}

# Function to continuously send requests (Downtime Monitoring)
monitor_downtime() {
    SERVICE_URL=$(minikube service $SERVICE_NAME --url)

    if [ -z "$SERVICE_URL" ]; then
        echo "ðŸš¨ ERROR: Could not determine service URL. Is the service '$SERVICE_NAME' running?" >&2
        exit 1
    fi

    echo "--- Monitoring $SERVICE_URL for downtime during update... (PID: $$) ---"
    
    # Loop indefinitely, sending curl requests every 0.5 seconds
    while true; do
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$SERVICE_URL")
        TIMESTAMP=$(date +%H:%M:%S)
        
        if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 301 ] || [ "$HTTP_CODE" -eq 302 ]; then
            echo "$TIMESTAMP: [SUCCESS] HTTP $HTTP_CODE"
        else
            echo "$TIMESTAMP: [FAILURE] HTTP $HTTP_CODE - DOWNTIME DETECTED!"
        fi
        sleep 0.5
    done
}

# Main function to run the update
main() {
    check_prerequisites
    
    echo "--- 1. Starting Rolling Update ---"

    # Start the downtime monitoring in the background
    monitor_downtime &
    MONITOR_PID=$!
    echo "Downtime monitoring started in the background (PID: $MONITOR_PID)."
    
    # Wait a second before applying the update
    sleep 2

    # Apply the modified deployment file to trigger the rolling update
    echo "Applying updated deployment file '$DEPLOYMENT_FILE'..."
    kubectl apply -f $DEPLOYMENT_FILE
    
    # 2. Monitor the update progress
    echo "--- 2. Monitoring Rollout Status ---"
    # This command blocks until the rollout is complete, successful, or failed.
    kubectl rollout status deployment/$DEPLOYMENT_NAME

    if [ $? -ne 0 ]; then
        echo "ðŸš¨ ERROR: Rolling Update failed." >&2
    else
        echo "âœ… Rolling Update successful."
    fi

    # 3. Stop the background monitoring process
    kill $MONITOR_PID &> /dev/null
    echo "--- 4. Downtime monitoring stopped."

    # 4. Verify the new pod version
    echo "--- 5. Verifying new pod versions ---"
    # This will show the age of the new pods and should confirm 2/2 or 3/3 ready.
    kubectl get pods -l app=django-app --show-labels
    echo "Look for the new image tag (v2.0) in the pod description to confirm the update."

    echo ""
    echo "ðŸŽ‰ Rolling update cycle complete."
}

# Execute the main function
main